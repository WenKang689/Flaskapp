<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cart</title>
    <style>
        .remove-button {
            background: none;
            border: none;
            color: red;
            font-size: 20px;
            cursor: pointer;
        }
        .remove-button:hover {
            color: darkred;
        }
        .product-link {
            text-decoration: none;
            color: black;
        }
        .product-link:hover {
            text-decoration: underline;
        }
        .error-message {
            color: red;
            display: none;
        }
        .checkout-disabled {
            background-color: gray;
            cursor: not-allowed;
        }
        .empty-cart-message {
            color: gray;
        }
    </style>
    <script>
        let originalQuantities = {};

        function updateSelectedTotalPrice() {
            let total = 0;
            let isAnyChecked = false;
            document.querySelectorAll('input[name^="select_"]:checked').forEach(checkbox => {
                isAnyChecked = true;
                const row = checkbox.closest('tr');
                const price = parseFloat(row.querySelector('.price').textContent.replace(/[^0-9.-]/g, ''));
                const quantity = parseInt(row.querySelector('input[name^="quantity_"]').value);
                total += price * quantity;
            });
            document.getElementById('selectedTotalPrice').textContent = total.toFixed(2);
            document.querySelector('button[name="action"][value="checkout"]').disabled = !isAnyChecked;
        }

        function toggleSelectAll(source) {
            const checkboxes = document.querySelectorAll('input[name^="select_"]');
            checkboxes.forEach(checkbox => checkbox.checked = source.checked);
            updateSelectedTotalPrice();
        }

        function checkStock() {
            document.querySelectorAll('input[name^="quantity_"]').forEach(input => {
                const productId = input.name.split('_')[1];
                const quantity = parseInt(input.value);
                const stock = parseInt(document.getElementById('stock_' + productId).textContent);
                const errorMessage = document.getElementById('error-message_' + productId);

                if (quantity > stock) {
                    errorMessage.textContent = 'Only ' + stock + ' items left in stock';
                    errorMessage.style.display = 'block';
                } else {
                    errorMessage.style.display = 'none';
                }
            });
        }

        function checkIfUpdated() {
            let hasChanges = false;
            document.querySelectorAll('input[name^="quantity_"]').forEach(input => {
                const productId = input.name.split('_')[1];
                const originalQuantity = originalQuantities[productId];
                const currentQuantity = parseInt(input.value);

                if (currentQuantity !== originalQuantity) {
                    hasChanges = true;
                }
            });
            document.querySelector('button[name="action"][value="update"]').disabled = !hasChanges;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize original quantities
            document.querySelectorAll('input[name^="quantity_"]').forEach(input => {
                const productId = input.name.split('_')[1];
                originalQuantities[productId] = parseInt(input.value);
            });

            checkStock();
            updateSelectedTotalPrice();

            document.querySelectorAll('input[name^="quantity_"]').forEach(input => {
                input.addEventListener('input', function() {
                    checkStock();
                    updateSelectedTotalPrice();
                    checkIfUpdated();
                });
            });

            document.querySelectorAll('input[name^="select_"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedTotalPrice);
            });
        });
    </script>
</head>
<body>
    <h1>Cart ({{ item_count }} items)</h1>
    {% if not cart_items %}
    <p class="empty-cart-message">Your cart is empty. <a href="{{ url_for('laptop') }}">View laptops here</a>.</p>
    {% else %}
    <form method="POST" action="{{ url_for('cart') }}">
        <table>
            <thead>
                <tr>
                    <th>
                        <input type="checkbox" onclick="toggleSelectAll(this)">
                        Select All
                    </th>
                    <th>Image</th>
                    <th>Product Name</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Subtotal</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in cart_items %}
                <tr>
                    <td>
                        <input type="checkbox" name="select_{{ item[0] }}" value="{{ item[0] }}" onclick="updateSelectedTotalPrice()">
                    </td>
                    <td>
                        <a href="{{ url_for('laptop_detail', product_id=item[0]) }}">
                            {% if item[4] %}
                            <img src="{{ item[4] }}" alt="Product Image" width="50" height="50">
                            {% else %}
                            <img src="default_image_url" alt="Default Image" width="50" height="50">
                            {% endif %}
                        </a>
                    </td>
                    <td>
                        <a href="{{ url_for('laptop_detail', product_id=item[0]) }}" class="product-link">{{ item[1] }}</a>
                    </td>
                    <td class="price">{{ item[2] }}</td>
                    <td>
                        <input type="number" name="quantity_{{ item[0] }}" value="{{ item[3] }}" min="1">
                        <span id="stock_{{ item[0] }}" style="display:none;">{{ item[5] }}</span>
                        <span id="error-message_{{ item[0] }}" class="error-message"></span>
                    </td>
                    <td>{{ item[2] * item[3] }}</td>
                    <td>
                        <button type="submit" name="remove_product" value="{{ item[0] }}" class="remove-button">&times;</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <h2>Checkout Total: RM<span id="selectedTotalPrice">{{ selected_total_price }}</span></h2>
        <button type="submit" name="action" value="update" disabled>Update Cart</button>
        <button type="submit" name="action" value="checkout" class="{{ not cart_items|length > 0 and 'checkout-disabled' }}">Proceed to Checkout</button>
        <p id="checkoutMessage" style="color: red; display: none;">Please select at least one product to proceed with checkout.</p>
    </form>

    <script>
        // Display checkout message if no products are selected
        document.querySelector('button[name="action"][value="checkout"]').addEventListener('click', function(event) {
            if (document.querySelectorAll('input[name^="select_"]:checked').length === 0) {
                event.preventDefault();
                document.getElementById('checkoutMessage').style.display = 'block';
            }
        });
    </script>
    {% endif %}
</body>
</html>
